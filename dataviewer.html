<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="src/base.css">
    <link href="src/fonts.css" rel="stylesheet">
</head>
<link rel="stylesheet" href="src/dataviewer.css">
<link rel="stylesheet" href="src/base.css">
<body>
    <div class="main" id="main">
        <div id="file-list-container" class="container">
            <div class="column-grid">
            </div>
        </div>
    </div>
    <div class="nav">
        <div class="navblock">
            <div class="exit" id="exit" onclick="quitPrompt()">
                <p>&#10060</p>
            </div>
            <div class="nava" onclick="redirectSmooth('./index.html')">
                <p>Monitor</p>
            </div>
            <div class="recordb nava" id="recordb" onclick="recordSwitch()">
                <p id="recordbt">Record</p>
            </div>
            <div class="nava navactive">
                <p>Files</p>
            </div>
            <div class="navb" onclick="closeBrowser()">
                <p>Close app</p>
            </div>
            <div class="navb navactive">
                <p>Turn Off H2Nose...</p>
            </div>
        </div>
    </div>
    <script>
        template = document.createElement('div');

        file = document.createElement('div')
        file.classList.add('file');

        tools = document.createElement('div');
        trash = document.createElement('img');
        trash.src = './src/TrashCan.svg';
        tools.append(trash)
        tools.classList.add('tools');

        template.append(file);
        template.append(tools);

        animating = false;

        document.addEventListener('DOMContentLoaded', ()=>{
            xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    files = JSON.parse(xhttp.responseText);
                    filelist = document.getElementsByClassName('column-grid')[0];
                    let keys = Object.keys(files).sort().reverse();
                    for(i of keys){
                        file = template.cloneNode(true);
                        file.childNodes[0].textContent = i;
                        file.childNodes[0].title = i;
                        file.childNodes[0].addEventListener('click', getRedirectFunction(i));
                        file.childNodes[1].childNodes[0].addEventListener('click', getDeleteFunction(i, file));
                        filelist.append(file);
                    }
                    if(keys.length == 0){
                        notfound = document.createElement('h1');
                        notfound.textContent = 'No Files Found';
                        filelist.replaceWith(notfound);
                    }
                }
            }
            xhttp.open('GET', 'http://127.0.0.1/f/names', true);
            xhttp.send();
            document.body.style.opacity = 1;
            setTimeout(()=>{
                document.body.style.transition = '0s';
            }, 1000);
        });

        getDeleteFunction = (i, f)=>{
            return (()=>{
                if(confirm('Delete '+i+'?')){
                    delhttp = new XMLHttpRequest();
                    delhttp.onreadystatechange = function() {
                        if (this.readyState == 4) {
                            if(this.status == 200){
                                f.remove();
                            } else if (this.status == 404){
                                alert('Failed to remove '+i);
                            }
                        } 
                    }
                    delhttp.open('GET', '/f/del?fn='+i);
                    delhttp.send();
                }
            })
        }

        getRedirectFunction = (i) => {
            return ()=>{if(animating){return};animating=true;window.location.href = './view/'+i;}
        }
    </script>
    <script>
        function redirectSmooth(url){
            if(animating){return;}
            animating = true;
            document.getElementById('main').style.transition = '1s';
            document.getElementById('main').style.opacity = 0;
            setTimeout(()=>{window.location.href = url;}, 1000);
        }
    </script>
</body>
